---
title: "analysis"
author: "CCP"
date: "12/14/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Bring in Libraries and Packages
```{r}
library(tidyverse)
library(data.table)
library(janitor)
library(magrittr)
library(ggsci)
library(CausalImpact)
library(reshape2)
library(forecast)
library(zoo)
library(astsa)
library(tseries)
```

# Bring in Data
```{r}
setwd("~/Documents/dartmouth/research/aim3_facebook_covid19_obesity/data")
obesity_1 <- fread("210526_facebook_obesity_1.csv")
obesity_2 <- fread("210526_facebook_obesity_2.csv")
obesity <- rbind(obesity_1, obesity_2) %>%
  clean_names()
rm(obesity_1, obesity_2)

headaches_1 <- fread("210627_headaches_1.csv")
headaches_2 <- fread("210627_headaches_2.csv")
headaches_3 <- fread("210627_headaches_3.csv")
headaches <- rbind(headaches_1, headaches_2, headaches_3) %>%
  clean_names()
rm(headaches_1, headaches_2, headaches_3)

clarinet <- fread("211104_facebook_clarinet_comparator.csv")
clarinet %<>%
  clean_names()
```

# Posts per Day
```{r}
obesity_count_per_day <- obesity %>%
  group_by(post_created_date) %>%
  summarise(posts_per_day = n()) %>%
  mutate(data_set = "Obesity")

headaches_count_per_day <- headaches %>%
  group_by(post_created_date) %>%
  summarise(posts_per_day = n()) %>%
  mutate(data_set = "Health Comparator")

clarinet_count_per_day <- clarinet %>%
  group_by(post_created_date) %>%
  summarise(posts_per_day = n()) %>%
  mutate(data_set = "Non-Health Comparator")

all_count_per_day <- rbind(obesity_count_per_day, headaches_count_per_day, clarinet_count_per_day)

all_count_per_day %>%
  mutate(data_set = factor(data_set, 
                           levels = c("Obesity",
                                      "Health Comparator",
                                      "Non-Health Comparator"))) %>%
  ggplot(aes(x = post_created_date,
             y = posts_per_day,
             color = data_set)) +
  geom_point() +
  geom_vline(xintercept = as.Date("2020-01-20"),
             linetype = "dashed") + 
  geom_vline(xintercept = as.Date("2020-03-11"),
             linetype = "dashed") +
  geom_vline(xintercept = as.Date("2020-05-19"),
             linetype = "dashed") +
  geom_vline(xintercept = as.Date("2020-10-20"),
             linetype = "dashed") +
  theme_classic() +
  scale_color_aaas() + 
  labs(title = "Temporal Variations in Obesity-Related Content on Facebook\nRelative to Comparators",
       x = "Date (Year-Month)",
       y = "Posts per Day",
       color = "Data Set") +
  theme(legend.position = "bottom")
setwd("~/Documents/dartmouth/research/aim3_facebook_covid19_obesity/figures")
ggsave("211214_change_in_posts_over_time_facebook.tiff", 
       width = 7.25,
       height = 4.51)
```

# ARIMA
## Function: ADF Test Only
```{r}
arima_its_adf_test <- function(its_date, 
                      dat, 
                      post_or_interaction = "post") {
  first_date = as.Date(its_date) - 14
  last_date = as.Date(its_date) + 14
  
  dat_filtered <- dat %>%
      dplyr::filter(post_created_date >= first_date &
                    post_created_date <= last_date)
  
  date_seq <- seq.Date(from = as.Date(first_date),
                         length.out = nrow(dat_filtered),
                         by = 1)

  if (post_or_interaction == "post") {
      dat_ts <- ts(as.numeric(dat_filtered$posts_per_day), 
                              start = first_date,
                              frequency = 365)

  } else {
      dat_ts <- ts(as.numeric(dat_filtered$interactions_per_day), 
                                   start = first_date,
                                   frequency = 365)
  }
  
  print(adf.test(dat_ts)) #Stationary data if significant (we want stationary)
}
```

## Function: ARIMA- ITS
```{r}
## Note: If adf.test is not significant, that means data needs to be differenced and this function re-run with difference = TRUE. This function does not difference the data. 
arima_its <- function(its_date, 
                      dat, 
                      difference = FALSE,
                      pulse = FALSE,
                      step = FALSE,
                      ramp = FALSE,
                      post_or_interaction = "post") {
  print(difference)
  first_date = as.Date(its_date) - 14
  last_date = as.Date(its_date) + 14
  
  dat_filtered <- dat %>%
      dplyr::filter(post_created_date >= first_date &
                    post_created_date <= last_date)
  
  date_seq <- seq.Date(from = as.Date(first_date),
                         length.out = nrow(dat_filtered),
                         by = 1)

  if (post_or_interaction == "post") {
      dat_ts <- ts(as.numeric(dat_filtered$posts_per_day), 
                              start = first_date,
                              frequency = 365)

  } else {
      dat_ts <- ts(as.numeric(dat_filtered$interactions_per_day), 
                                   start = first_date,
                                   frequency = 365)
  }
  
  print(adf.test(dat_ts)) #Stationary data if significant (we want stationary)

## Step Parameter
  transfer <- c()
  if (step == TRUE) {
    dat_step <- ifelse(date_seq >= its_date, 1, 0)
    transfer <- cbind(transfer, dat_step)
  }

## Ramp Parameter
  if (ramp == TRUE) {
    dat_step <- ifelse(date_seq >= its_date, 1, 0)
    dat_ramp <- append(rep(0,
                         length(which(dat_step == 0))),
                     seq(1,
                         length(which(dat_step == 1)),
                         1))
    transfer <- cbind(transfer, dat_ramp)
  }
## Pulse Parameter
  if (pulse == TRUE) {
    dat_pulse <- ifelse(date_seq == its_date, 1, 0)
    transfer <- cbind(transfer, dat_pulse)
  }

  if (difference == TRUE) {
    print("Running with differencing")
      model_func <- auto.arima(dat_ts,
                               d = 1, #Considers differencing data
                               xreg = transfer)
  } else {
    print("Running with no differencing")
      model_func <- auto.arima(dat_ts,
                               xreg = transfer)
  }

  print(Box.test(model_func$residuals, 
           type = "Ljung-Box")) 

  print(summary(model_func))
  print(confint(model_func))
  print((1-pnorm(abs(model_func$coef)/sqrt(diag(model_func$var.coef))))*2)
}
```

## Plotting
```{r}
headaches_count_per_day %>%
  dplyr::filter(post_created_date >= as.Date("2020-03-11") - 30 &
                  post_created_date <= as.Date("2020-03-11") + 30) %>%
  ggplot(aes(x = post_created_date,
             y = as.numeric(posts_per_day))) +
  geom_line() +
  geom_vline(xintercept = as.Date("2020-03-11")) + 
  theme_classic()

obesity_count_per_day %>%
  dplyr::filter(post_created_date >= as.Date("2020-05-19") - 30 &
                  post_created_date <= as.Date("2020-10-02") + 30) %>%
  mutate(color_plot = case_when(
    post_created_date <= as.Date("2020-05-19") ~ "Period 1",
    post_created_date >= as.Date("2020-10-02") ~ "Period 3",
    TRUE ~ "Period 2"
  )) %>%
  ggplot(aes(x = post_created_date,
             y = as.numeric(posts_per_day),
             color = color_plot)) +
  geom_line(size = 1) +
  geom_vline(xintercept = c(as.Date("2020-05-19"),
                            as.Date("2020-10-02")),
             linetype = "dashed",
             size = 0.75) + 
  theme_classic() +
  theme(legend.position = "none") + 
  scale_x_date(date_labels = "%b",
               date_breaks = "1 month") +
  labs(x = "Month",
       y = "Posts Per Day",
       title = "Obesity Posts per Day on Facebook\nApril 19, 2020 - November 1, 2020")
setwd("~/Documents/dartmouth/research/aim3_facebook_covid19_obesity/figures")
ggsave("220105_month_posts_facebook.tiff",
       width = 7.25,
       height = 4.51)
```

## Model Selection
```{r}
for (d in list_of_its_dates) {
  print(as.Date(d))
    print("pulse only")
    arima_its(d, obesity_count_per_day, "post", pulse = TRUE)
    print("**********")

    print("step only")
    arima_its(d, obesity_count_per_day, "post", step = TRUE)
    print("**********")
  
    print("ramp only")
    arima_its(d, obesity_count_per_day, "post", ramp = TRUE)
    print("**********")
  
    print("pulse + step only")
    arima_its(d, obesity_count_per_day, "post", pulse = TRUE, step = TRUE)
    print("**********")

    print("pulse + ramp only")
    arima_its(d, obesity_count_per_day, "post", pulse = TRUE, ramp = TRUE)
    print("**********")
  
    print("step + ramp only")
    arima_its(d, obesity_count_per_day, "post", step = TRUE, ramp = TRUE)
    print("**********")

    print("all")
    arima_its(d, obesity_count_per_day, "post", pulse = TRUE, step = TRUE, 
              ramp = TRUE)
    print("**********")
}

## Running May 19th with first differences
print("pulse only")
arima_its(as.Date("2020-05-19"), obesity_count_per_day, difference = TRUE, 
          pulse = TRUE)
print("**********")

print("step only")
arima_its(as.Date("2020-05-19"), obesity_count_per_day, difference = TRUE, 
          step = TRUE)
print("**********")
  
print("ramp only")
arima_its(as.Date("2020-05-19"), obesity_count_per_day, difference = TRUE, 
          ramp = TRUE)
print("**********")
  
print("pulse + step only")
arima_its(as.Date("2020-05-19"), obesity_count_per_day, difference = TRUE, 
          pulse = TRUE, step = TRUE)
print("**********")

print("pulse + ramp only")
arima_its(as.Date("2020-05-19"), obesity_count_per_day, difference = TRUE, 
          pulse = TRUE, ramp = TRUE)
print("**********")
  
print("step + ramp only")
arima_its(as.Date("2020-05-19"), obesity_count_per_day, difference = TRUE, 
          step = TRUE, ramp = TRUE)
print("**********")

print("all")
arima_its(as.Date("2020-05-19"), obesity_count_per_day, difference = TRUE, 
          pulse = TRUE, step = TRUE, ramp = TRUE)
print("**********")


```

## Running Models
- January 20th: Pulse only [first difference health & non-health]
- March 11th: Pulse only [first difference health]
- May 19th: Pulse + step [need to first difference obesity]
- October 2nd: All
```{r}
dfs <- c("obesity_count_per_day", "headaches_count_per_day", "clarinet_count_per_day" )
# January 20th
for (df in dfs) {
  print(df)
  if (df == "obesity_count_per_day") {
    arima_its(as.Date("2020-01-20"), get(df), difference = FALSE, pulse = TRUE)
  } else {
    arima_its(as.Date("2020-01-20"), get(df), difference = TRUE, pulse = TRUE)
  }
}

# March 11th
for (df in dfs) {
  print(df)
  if (df == "headaches_count_per_day") {
    arima_its(as.Date("2020-03-11"), get(df), difference = TRUE, 
              pulse = TRUE)
  } else {
    arima_its(as.Date("2020-03-11"), get(df), difference = FALSE, 
              pulse = TRUE)
  }
}

# May 19th
for (df in dfs) {
  print(df)
  if (df == "obesity_count_per_day") {
    arima_its(as.Date("2020-05-19"), get(df), difference = TRUE, 
              pulse = TRUE, step = TRUE)
  } else {
    arima_its(as.Date("2020-05-19"), get(df), difference = FALSE, 
              pulse = TRUE, step = TRUE)
  }
}

```

# Interactions per Day
```{r}
obesity %<>%
  mutate(total_interactions_numeric = as.numeric(str_remove(total_interactions, " ")))

headaches %<>%
  mutate(total_interactions_numeric = as.numeric(str_remove(total_interactions, " ")))

clarinet %<>%
  mutate(total_interactions_numeric = as.numeric(str_remove(total_interactions, " ")))

obesity_interaction_per_day <- obesity %>%
  group_by(post_created_date) %>%
  summarise(interactions_per_day = sum(total_interactions_numeric, na.rm = TRUE)) %>%
  mutate(data_set = "Obesity")

headaches_interaction_per_day <- headaches %>%
  group_by(post_created_date) %>%
  summarise(interactions_per_day = sum(total_interactions_numeric, na.rm = TRUE)) %>%
  mutate(data_set = "Health Comparator")

clarinet_interaction_per_day <- clarinet %>%
  group_by(post_created_date) %>%
  summarise(interactions_per_day = sum(total_interactions_numeric, na.rm = TRUE)) %>%
  mutate(data_set = "Non-Health Comparator")

all_interactions_per_day <- rbind(obesity_interaction_per_day, headaches_interaction_per_day, clarinet_interaction_per_day)

all_interactions_per_day %>%
  mutate(data_set = factor(data_set, 
                           levels = c("Obesity",
                                      "Health Comparator",
                                      "Non-Health Comparator"))) %>%
  ggplot(aes(x = post_created_date,
             y = interactions_per_day,
             color = data_set)) +
  geom_point() +
  geom_vline(xintercept = as.Date("2020-01-20"),
             linetype = "dashed") + 
  geom_vline(xintercept = as.Date("2020-03-11"),
             linetype = "dashed") +
  geom_vline(xintercept = as.Date("2020-05-19"),
             linetype = "dashed") +
  geom_vline(xintercept = as.Date("2020-10-20"),
             linetype = "dashed") +
  theme_classic() +
  scale_color_aaas() + 
  labs(title = "Temporal Variations in Interactions Obesity-Related Content on Facebook\nRelative to Comparators",
       x = "Date (Year-Month)",
       y = "Interactions (Count)",
       color = "Data Set") +
  theme(legend.position = "bottom")
setwd("~/Documents/dartmouth/research/aim3_facebook_covid19_obesity/figures")
ggsave("211214_change_in_interactions_over_time_facebook.tiff", 
       width = 7.25,
       height = 4.51)
```

## Model Selection
```{r}
for (d in list_of_its_dates) {
  print(as.Date(d))
    print("pulse only")
    arima_its(d, obesity_interaction_per_day, pulse = TRUE, 
              post_or_interaction = "interactions")
    print("**********")

    print("step only")
    arima_its(d, obesity_interaction_per_day, step = TRUE, 
              post_or_interaction = "interactions")
    print("**********")
  
    print("ramp only")
    arima_its(d, obesity_interaction_per_day, ramp = TRUE, 
              post_or_interaction = "interactions")
    print("**********")
  
    print("pulse + step only")
    arima_its(d, obesity_interaction_per_day, pulse = TRUE, step = TRUE,
              post_or_interaction = "interactions")
    print("**********")

    print("pulse + ramp only")
    arima_its(d, obesity_interaction_per_day, pulse = TRUE, ramp = TRUE,
              post_or_interaction = "interactions")
    print("**********")
  
    print("step + ramp only")
    arima_its(d, obesity_interaction_per_day, step = TRUE, ramp = TRUE,
              post_or_interaction = "interactions")
    print("**********")

    print("all")
    arima_its(d, obesity_interaction_per_day, pulse = TRUE, step = TRUE, 
              ramp = TRUE, post_or_interaction = "interactions")
    print("**********")
}

## Running January 20th, March 11th, and May 19th with first differences
for (d in list_of_its_dates[1:3]) {
  print(as.Date(d))
    print("pulse only")
    arima_its(d, obesity_interaction_per_day, pulse = TRUE, 
              post_or_interaction = "interactions", difference = TRUE)
    print("**********")

    print("step only")
    arima_its(d, obesity_interaction_per_day, step = TRUE, 
              post_or_interaction = "interactions", difference = TRUE)
    print("**********")
  
    print("ramp only")
    arima_its(d, obesity_interaction_per_day, ramp = TRUE, 
              post_or_interaction = "interactions", difference = TRUE)
    print("**********")
  
    print("pulse + step only")
    arima_its(d, obesity_interaction_per_day, pulse = TRUE, step = TRUE,
              post_or_interaction = "interactions", difference = TRUE)
    print("**********")

    print("pulse + ramp only")
    arima_its(d, obesity_interaction_per_day, pulse = TRUE, ramp = TRUE,
              post_or_interaction = "interactions", difference = TRUE)
    print("**********")
  
    print("step + ramp only")
    arima_its(d, obesity_interaction_per_day, step = TRUE, ramp = TRUE,
              post_or_interaction = "interactions", difference = TRUE)
    print("**********")

    print("all")
    arima_its(d, obesity_interaction_per_day, pulse = TRUE, step = TRUE, 
              ramp = TRUE, post_or_interaction = "interactions", difference = TRUE)
    print("**********")
}
```

## Checking for Differencing in Control Data
```{r}
dfs_interactions <- c("obesity_interaction_per_day", 
                      "headaches_interaction_per_day", "clarinet_interaction_per_day")

for (d in list_of_its_dates) {
  print(as.Date(d)) 
  for (df in dfs_interactions) {
    print(df)
    arima_its_adf_test(d, get(df), "interactions")
  }
}
```

## Running Models
- January 20th: Step only [first difference obesity & non-health]
- March 11th: Step only [first difference all]
- May 19th: Pulse + step [first difference obesity & health]
- October 2nd: Pulse + ramp [first difference health]
```{r}
# January 20th
for (df in dfs_interactions) {
  print(df)
  if (df == "headaches_interaction_per_day") {
    arima_its(as.Date("2020-01-20"), get(df), 
              difference = FALSE, 
              step = TRUE, 
              post_or_interaction = "interaction")
  } else {
    arima_its(as.Date("2020-01-20"), get(df), 
              post_or_interaction = "interaction", 
              difference = TRUE, 
              step = TRUE)
  }
}

# March 11th
for (df in dfs_interactions) {
  print(df)
  arima_its(as.Date("2020-03-11"), get(df), 
            post_or_interaction = "interaction", 
            difference = TRUE, 
            step = TRUE)
}

# May 19th
for (df in dfs_interactions) {
  print(df)
  if (df == "clarinet_interaction_per_day") {
    arima_its(as.Date("2020-05-19"), get(df), post_or_interaction = "interaction", 
              difference = FALSE,
              pulse = TRUE, step = TRUE)
  } else {
    arima_its(as.Date("2020-05-19"), get(df), post_or_interaction = "interaction", 
              difference = TRUE, 
              pulse = TRUE, step = TRUE)
  }
}

# October 2nd
for (df in dfs_interactions) {
  print(df)
  if (df == "headaches_interaction_per_day") {
    arima_its(as.Date("2020-05-19"), get(df), post_or_interaction = "interaction", 
              difference = TRUE, 
              pulse = TRUE, ramp = TRUE)
  } else {
    arima_its(as.Date("2020-05-19"), get(df), post_or_interaction = "interaction", 
              difference = FALSE, 
              pulse = TRUE, ramp = TRUE)
  }
}

```

