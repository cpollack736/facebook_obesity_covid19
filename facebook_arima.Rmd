---
title: "analysis"
author: "CCP"
date: "12/14/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Bring in Libraries and Packages
```{r}
library(tidyverse)
library(data.table) #fread
library(janitor) #clean_names
library(zoo) #numeric date to date
library(aTSA) #adf.test
library(forecast) #arima
library(magrittr) #%<>%
library(scales) #commas on plots
```

# Bring in Data
```{r}
setwd("~/Documents/dartmouth/research/aim3_facebook_covid19_obesity/data")
obesity_1 <- fread("210526_facebook_obesity_1.csv")
obesity_2 <- fread("210526_facebook_obesity_2.csv")
obesity <- rbind(obesity_1, obesity_2) %>%
  clean_names()
rm(obesity_1, obesity_2)

setwd("~/Documents/dartmouth/research/aim3_facebook_covid19_obesity/data")
headaches_1 <- fread("210627_headaches_1.csv")
headaches_2 <- fread("210627_headaches_2.csv")
headaches_3 <- fread("210627_headaches_3.csv")
headaches <- rbind(headaches_1, headaches_2, headaches_3) %>%
  clean_names()
rm(headaches_1, headaches_2, headaches_3)

setwd("~/Documents/dartmouth/research/aim3_facebook_covid19_obesity/data")
clarinet <- fread("211104_facebook_clarinet_comparator.csv")
clarinet %<>%
  clean_names()
```

# Functions

## ADF Test
```{r}
arima_its_adf_test <- function(its_date, 
                      dat, 
                      post_or_interaction = "post") {
  first_date = as.Date(its_date) - 14
  last_date = as.Date(its_date) + 14
  
  dat_filtered <- dat %>%
      dplyr::filter(post_created_date >= first_date &
                    post_created_date <= last_date)
  
  date_seq <- seq.Date(from = as.Date(first_date),
                         length.out = nrow(dat_filtered),
                         by = 1)

  if (post_or_interaction == "post") {
      dat_ts <- ts(as.numeric(dat_filtered$posts_per_day), 
                              start = first_date,
                              frequency = 365)

  } else {
      dat_ts <- ts(as.numeric(dat_filtered$interactions_per_day), 
                                   start = first_date,
                                   frequency = 365)
  }
  
  print(adf.test(dat_ts)) #Stationary data if significant (we want stationary)
}
```

## ARIMA- ITS
```{r}
## Note: If adf.test is not significant, that means data needs to be differenced and this function re-run with difference = TRUE. This function does not difference the data. 
arima_its <- function(its_date, 
                      dat, 
                      difference = NA,
                      pulse = FALSE,
                      step = FALSE,
                      ramp = FALSE,
                      post_or_interaction = "post") {
  print(difference)
  first_date = as.Date(its_date) - 14
  last_date = as.Date(its_date) + 14
  
  dat_filtered <- dat %>%
      dplyr::filter(post_created_date >= first_date &
                    post_created_date <= last_date)
  
  date_seq <- seq.Date(from = as.Date(first_date),
                         length.out = nrow(dat_filtered),
                         by = 1)

  if (post_or_interaction == "post") {
      dat_ts <- ts(as.numeric(dat_filtered$posts_per_day), 
                              start = first_date,
                              frequency = 365)

  } else {
      dat_ts <- ts(as.numeric(dat_filtered$interactions_per_day), 
                                   start = first_date,
                                   frequency = 365)
  }
  
  #print(adf.test(dat_ts)) #Stationary data if significant (we want stationary)

## Step Parameter
  transfer <- c()
  if (step == TRUE) {
    dat_step <- ifelse(date_seq >= its_date, 1, 0)
    transfer <- cbind(transfer, dat_step)
  }

## Ramp Parameter
  if (ramp == TRUE) {
    dat_step <- ifelse(date_seq >= its_date, 1, 0)
    dat_ramp <- append(rep(0,
                         length(which(dat_step == 0))),
                     seq(1,
                         length(which(dat_step == 1)),
                         1))
    transfer <- cbind(transfer, dat_ramp)
  }
## Pulse Parameter
  if (pulse == TRUE) {
    dat_pulse <- ifelse(date_seq == its_date, 1, 0)
    transfer <- cbind(transfer, dat_pulse)
  }

  if (!is.na(difference)) {
    print(paste0("Running with differencing of ", difference))
      model_func <- auto.arima(dat_ts,
                               d = difference, #Considers differencing data
                               xreg = transfer,
                               stepwise = FALSE,
                               max.order = 10)
  } else {
    print("Running with no differencing")
      model_func <- auto.arima(dat_ts,
                               xreg = transfer,
                               stepwise = FALSE,
                               max.order = 10)
  }

  #print(Box.test(model_func$residuals, 
  #         type = "Ljung-Box")) 

  print(summary(model_func))
  print(confint(model_func))
  print((1-pnorm(abs(model_func$coef)/sqrt(diag(model_func$var.coef))))*2)
}
```

## ARIMA-ITS - Fixed Parameters
```{r}
## Note: This function assumes that p,d, and q parameters have already been found in a prior step

arima_its_fixed_pq <- function(its_date, 
                      dat, 
                      difference = NA,
                      pulse = FALSE,
                      step = FALSE,
                      ramp = FALSE,
                      post_or_interaction = "post",
                      p = NA,
                      d = NA,
                      q = NA) {
  print(difference)
  first_date = as.Date(its_date) - 14
  last_date = as.Date(its_date) + 14
  
  dat_filtered <- dat %>%
      dplyr::filter(post_created_date >= first_date &
                    post_created_date <= last_date)
  
  date_seq <- seq.Date(from = as.Date(first_date),
                         length.out = nrow(dat_filtered),
                         by = 1)

  if (post_or_interaction == "post") {
      dat_ts <- ts(as.numeric(dat_filtered$posts_per_day), 
                              start = first_date,
                              frequency = 365)

  } else {
      dat_ts <- ts(as.numeric(dat_filtered$interactions_per_day), 
                                   start = first_date,
                                   frequency = 365)
  }
  
  #print(adf.test(dat_ts)) #Stationary data if significant (we want stationary)

## Step Parameter
  transfer <- c()
  if (step == TRUE) {
    dat_step <- ifelse(date_seq >= its_date, 1, 0)
    transfer <- cbind(transfer, dat_step)
  }

## Ramp Parameter
  if (ramp == TRUE) {
    dat_step <- ifelse(date_seq >= its_date, 1, 0)
    dat_ramp <- append(rep(0,
                         length(which(dat_step == 0))),
                     seq(1,
                         length(which(dat_step == 1)),
                         1))
    transfer <- cbind(transfer, dat_ramp)
  }
## Pulse Parameter
  if (pulse == TRUE) {
    dat_pulse <- ifelse(date_seq == its_date, 1, 0)
    transfer <- cbind(transfer, dat_pulse)
  }

  if (!is.na(difference)) {
    print(paste0("Running with differencing of ", difference))
      model_func <- Arima(dat_ts,
                          order = c(p, difference, q),
                          xreg = transfer)
  } else {
    print("Running with no differencing")
      model_func <- Arima(dat_ts,
                          order = c(p, 0, q),
                          xreg = transfer)
  }

  #print(Box.test(model_func$residuals, 
  #         type = "Ljung-Box")) 

  print(summary(model_func))
  print(confint(model_func))
  print((1-pnorm(abs(model_func$coef)/sqrt(diag(model_func$var.coef))))*2)
}

```

# Posts per Day
```{r}
obesity_count_per_day <- obesity %>%
  group_by(post_created_date) %>%
  summarise(posts_per_day = n()) %>%
  mutate(data_set = "Obesity")

headaches_count_per_day <- headaches %>%
  group_by(post_created_date) %>%
  summarise(posts_per_day = n()) %>%
  mutate(data_set = "Health Comparator")

clarinet_count_per_day <- clarinet %>%
  group_by(post_created_date) %>%
  summarise(posts_per_day = n()) %>%
  mutate(data_set = "Non-Health Comparator")

all_count_per_day <- rbind(obesity_count_per_day, headaches_count_per_day, clarinet_count_per_day)
```

## Plotting
```{r}
obesity_count_per_day %>%
  dplyr::filter(post_created_date >= as.Date("2020-01-06") &
           post_created_date <= as.Date("2020-10-16")) %>%
  dplyr::mutate(color_plot = dplyr::case_when(
    post_created_date >= as.Date("2020-01-20") - 14 &
      post_created_date <= as.Date("2020-01-20") + 14 ~ "First US Case: Jan. 6 - Feb. 3",
    post_created_date >= as.Date("2020-03-11") - 14 &
      post_created_date <= as.Date("2020-03-11") + 14 ~ "COVID-19 Pandemic: Feb. 26 - Mar. 25",
    post_created_date >= as.Date("2020-05-19") - 14 &
      post_created_date <= as.Date("2020-05-19") + 14 ~ "Obesity + COVID-19: May 5 - June 2",
    post_created_date >= as.Date("2020-10-02") - 14 &
      post_created_date <= as.Date("2020-10-02") + 14 ~ "Trump + COVID-19: Sept. 18 - Oct. 16",
    TRUE ~ ""),
    color_plot = relevel(as.factor(color_plot), ref = "First US Case: Jan. 6 - Feb. 3")) %>%
  filter(color_plot != "") %>%
  ggplot(aes(x = post_created_date,
             y = posts_per_day,
             color = color_plot,
             group = color_plot)) +
  geom_line(size = 0.75) +
  geom_vline(xintercept = c(as.Date("2020-01-20"), as.Date("2020-03-11"),  as.Date("2020-05-19"), as.Date("2020-10-02")),
             linetype = "dashed") + 
  theme_classic() +
  facet_wrap(~color_plot, scales = "free_x") +
  scale_color_manual(values = c("#4E79A7",
                                "#F28E2B",
                                "#B07AA1",
                                "#FF9DA7")) +
  labs(x = "Date",
       y = "Posts per Day",
       title = "Distribution of Posts per Day Around Major News Stories") +
  theme(legend.position = "none")
setwd("~/Documents/dartmouth/research/aim3_facebook_covid19_obesity/figures")
ggsave("220403_topics_per_day_facebook_facet.tiff",
       width = 7.25, 
       height = 4.51)
```


## Checking for Differencing Need
```{r}
list_of_its_dates <- c(as.Date("2020-01-20"),
                       as.Date("2020-03-11"),
                       as.Date("2020-05-19"),
                       as.Date("2020-10-02"))

dfs_posts <- c("obesity_count_per_day", 
                      "headaches_count_per_day",
                      "clarinet_count_per_day")

for (d in list_of_its_dates) {
  print(as.Date(d))
  for (df in dfs_posts) {
    print(df)
    arima_its_adf_test(d, get(df))
  }
}
```

## Model Selection
- January 20th: Difference obesity
- March 11th: Difference non-health control
- May 19th: Difference health control
- October 2nd: No difference
```{r}
# No differencing (everything but January 20)
for (d in list_of_its_dates) {
  if (as.Date(d) == as.Date("2020-03-11")) {
    diff = 2
  } else if (as.Date(d) == as.Date("2020-05-19")) {
    diff = 1
  } else {
    diff = NA
  }
  print(as.Date(d))
  print("pulse only")
  arima_its(d, obesity_count_per_day, pulse = TRUE,
            difference = diff)
  print("**********")
  
  print("step only")
  arima_its(d, obesity_count_per_day, step = TRUE,
            difference = diff)
  print("**********")
  
  print("ramp only")
  arima_its(d, obesity_count_per_day, ramp = TRUE,
            difference = diff)
  print("**********")
  
  print("pulse + step only")
  arima_its(d, obesity_count_per_day, 
            pulse = TRUE, 
            step = TRUE,
            difference = diff)
  print("**********")
  
  print("pulse + ramp only")
  arima_its(d, obesity_count_per_day, 
            pulse = TRUE, ramp = TRUE,
            difference = diff)
  print("**********")
  
  print("step + ramp only")
  arima_its(d, obesity_count_per_day, 
            step = TRUE, ramp = TRUE,
            difference = diff)
  print("**********")
  
  print("all")
  arima_its(d, obesity_count_per_day,
            pulse = TRUE, step = TRUE, ramp = TRUE,
            difference = diff)
  print("**********")
}
```

## Running Models
- January 20th: Lag 1 health, ramp
- March 11th: Lag 2 obesity, pulse
- May 19th: Difference health control
- October 2nd: No difference
```{r}
# January 20th
for (df in dfs_posts) {
  print(df)
  if (df == "headaches_count_per_day") {
    arima_its(as.Date("2020-01-20"), get(df), 
              difference = 1, 
              ramp = TRUE)
  } else {
    arima_its(as.Date("2020-01-20"), get(df), 
              ramp = TRUE)
  }
}

# March 11th
for (df in dfs_posts) {
  print(df)
  if (df == "obesity_count_per_day") {
    arima_its(as.Date("2020-03-11"), get(df), 
              difference = 2, 
              pulse = TRUE)
  } else {
    arima_its(as.Date("2020-03-11"), get(df), 
              pulse = TRUE)
  }
}

# May 19th
for (df in dfs_posts) {
  print(df)
  if (df == "obesity_count_per_day") {
    arima_its(as.Date("2020-05-19"), get(df),
              difference = 1,
              pulse = TRUE, step = TRUE)
  } else {
    arima_its(as.Date("2020-05-19"), get(df),
              pulse = TRUE, step = TRUE)
  }
}

# October 2nd
for (df in dfs_posts) {
  print(df)
    arima_its(as.Date("2020-10-02"), get(df),
              pulse = TRUE, ramp = TRUE)
  }
```


# Interactions per Day
```{r}
obesity %<>%
  mutate(total_interactions_numeric = as.numeric(str_remove(total_interactions, " ")))

headaches %<>%
  mutate(total_interactions_numeric = as.numeric(str_remove(total_interactions, " ")))

clarinet %<>%
  mutate(total_interactions_numeric = as.numeric(str_remove(total_interactions, " ")))

obesity_interaction_per_day <- obesity %>%
  group_by(post_created_date) %>%
  summarise(interactions_per_day = sum(total_interactions_numeric, na.rm = TRUE)) %>%
  mutate(data_set = "Obesity")

headaches_interaction_per_day <- headaches %>%
  group_by(post_created_date) %>%
  summarise(interactions_per_day = sum(total_interactions_numeric, na.rm = TRUE)) %>%
  mutate(data_set = "Health Comparator")

clarinet_interaction_per_day <- clarinet %>%
  group_by(post_created_date) %>%
  summarise(interactions_per_day = sum(total_interactions_numeric, na.rm = TRUE)) %>%
  mutate(data_set = "Non-Health Comparator")

all_interactions_per_day <- rbind(obesity_interaction_per_day, headaches_interaction_per_day, clarinet_interaction_per_day)

```

## Plotting
```{r}
obesity_interaction_per_day %>%
  dplyr::filter(post_created_date >= as.Date("2020-01-06") &
           post_created_date <= as.Date("2020-10-16")) %>%
  dplyr::mutate(color_plot = dplyr::case_when(
    post_created_date >= as.Date("2020-01-20") - 14 &
      post_created_date <= as.Date("2020-01-20") + 14 ~ "First US Case: Jan. 6 - Feb. 3",
    post_created_date >= as.Date("2020-03-11") - 14 &
      post_created_date <= as.Date("2020-03-11") + 14 ~ "COVID-19 Pandemic: Feb. 26 - Mar. 25",
    post_created_date >= as.Date("2020-05-19") - 14 &
      post_created_date <= as.Date("2020-05-19") + 14 ~ "Obesity + COVID-19: May 5 - June 2",
    post_created_date >= as.Date("2020-10-02") - 14 &
      post_created_date <= as.Date("2020-10-02") + 14 ~ "Trump + COVID-19: Sept. 18 - Oct. 16",
    TRUE ~ ""),
    color_plot = relevel(as.factor(color_plot), ref = "First US Case: Jan. 6 - Feb. 3")) %>%
  filter(color_plot != "") %>%
  ggplot(aes(x = post_created_date,
             y = interactions_per_day,
             color = color_plot,
             group = color_plot)) +
  geom_line(size = 0.75) +
  geom_vline(xintercept = c(as.Date("2020-01-20"), as.Date("2020-03-11"),  as.Date("2020-05-19"), as.Date("2020-10-02")),
             linetype = "dashed") + 
  theme_classic() +
  facet_wrap(~color_plot, scales = "free_x") +
  scale_color_manual(values = c("#4E79A7",
                                "#F28E2B",
                                "#B07AA1",
                                "#FF9DA7")) +
  scale_y_continuous(label = comma) + 
  labs(x = "Date",
       y = "Interactions per Day",
       title = "Distribution of Interactions per Day Around Major News Stories") +
  theme(legend.position = "none")
setwd("~/Documents/dartmouth/research/aim3_facebook_covid19_obesity/figures")
ggsave("220403_interactions_per_day_facebook_facet.tiff",
       width = 7.25, 
       height = 4.51)
```

## Checking for Differencing Need
```{r}
list_of_its_dates <- c(as.Date("2020-01-20"),
                       as.Date("2020-03-11"),
                       as.Date("2020-05-19"),
                       as.Date("2020-10-02"))

dfs_posts <- c("obesity_interaction_per_day", 
               "headaches_interaction_per_day",
               "clarinet_interaction_per_day")

for (d in list_of_its_dates) {
  print(as.Date(d))
  for (df in dfs_posts) {
    print(df)
    arima_its_adf_test(d, get(df), post_or_interaction = "interactions")
  }
}
```

## Model Selection
- January 20th: Lag 1
- All Others: Lag 0
```{r}
# No differencing (everything but January 20)
for (d in list_of_its_dates) {
  if (as.Date(d) == as.Date("2020-01-20")) {
    diff = 1
  } else {
    diff = NA
  }
  print(as.Date(d))
  print("pulse only")
  arima_its(d, obesity_interaction_per_day, pulse = TRUE,
            difference = diff,
            post_or_interaction = "interactions")
  print("**********")
  
  print("step only")
  arima_its(d, obesity_interaction_per_day, step = TRUE,
            difference = diff,
            post_or_interaction = "interactions")
  print("**********")
  
  print("ramp only")
  arima_its(d, obesity_interaction_per_day, ramp = TRUE,
            difference = diff,
            post_or_interaction = "interactions")
  print("**********")
  
  print("pulse + step only")
  arima_its(d, obesity_interaction_per_day, 
            pulse = TRUE, 
            step = TRUE,
            difference = diff,
            post_or_interaction = "interactions")
  print("**********")
  
  print("pulse + ramp only")
  arima_its(d, obesity_interaction_per_day, 
            pulse = TRUE, ramp = TRUE,
            difference = diff,
            post_or_interaction = "interactions")
  print("**********")
  
  print("step + ramp only")
  arima_its(d, obesity_interaction_per_day, 
            step = TRUE, ramp = TRUE,
            difference = diff,
            post_or_interaction = "interactions")
  print("**********")
  
  print("all")
  arima_its(d, obesity_interaction_per_day,
            pulse = TRUE, step = TRUE, ramp = TRUE,
            difference = diff,
            post_or_interaction = "interactions")
  print("**********")
}
```

## Running Models
- January 20th: Lag 1 all, step
- March 11th: Lag 0 all, pulse
- May 19th: Lag 2 non-health, pulse step ramp
- October 2nd: Lag 0 all, pulse step
```{r}
# January 20th
dfs_posts <- c("obesity_interaction_per_day", "headaches_interaction_per_day", "clarinet_interaction_per_day")
for (df in dfs_posts) {
  print(df)
  arima_its(as.Date("2020-01-20"), 
            get(df),
            difference = 1, 
            post_or_interaction = "interactions", 
            step = TRUE)
}

# March 11th
for (df in dfs_posts) {
  print(df)
  arima_its(as.Date("2020-03-11"), 
            get(df),
            post_or_interaction = "interactions", 
            pulse = TRUE)
}
# May 19th
for (df in dfs_posts) {
  print(df)
  if (df == "clarinet_interaction_per_day") {
    arima_its(as.Date("2020-05-19"), 
              get(df),
              difference = 2, 
              post_or_interaction = "interactions",
              pulse = TRUE, step = TRUE, ramp = TRUE)
  } else {
    arima_its(as.Date("2020-05-19"), 
              get(df),
              post_or_interaction = "interactions", 
              pulse = TRUE, step = TRUE, ramp = TRUE)
  }
}

# October 2nd
for (df in dfs_posts) {
  print(df)
  arima_its(as.Date("2020-10-02"), 
            get(df),
            difference = 0, 
            post_or_interaction = "interactions", 
            pulse = TRUE,
            step = TRUE)
}
```

# Repeating Health and Non-Health Models Using preset p,d,q
## Posts
- January 20th: p = 0, q = 1
- March 11th: p = 5, q = 0
- May 19th: p = 0, q = 1
- October 2nd: p = 3, q = 0
```{r}
# January 20th
for (df in dfs_posts) {
  print(df)
  if (df == "headaches_count_per_day") {
    arima_its_fixed_pq(as.Date("2020-01-20"), get(df), 
              difference = 1, 
              ramp = TRUE,
              p = 0, q = 1)
  } else {
    arima_its_fixed_pq(as.Date("2020-01-20"), get(df), 
              ramp = TRUE,
              p = 0, q = 1)
  }
}

# March 11th
for (df in dfs_posts) {
  print(df)
  if (df == "obesity_count_per_day") {
    arima_its_fixed_pq(as.Date("2020-03-11"), get(df), 
              difference = 2, 
              pulse = TRUE,
              p = 5, q = 0)
  } else if (df == "headaches_count_per_day") {
      arima_its_fixed_pq(as.Date("2020-03-11"), get(df), 
            difference = 1, 
            pulse = TRUE,
            p = 5, q = 0)
  } else {
    arima_its_fixed_pq(as.Date("2020-03-11"), get(df), 
              pulse = TRUE,
              p = 5, q = 0)
  }
}

# May 19th
for (df in dfs_posts) {
  print(df)
  if (df == "obesity_count_per_day") {
    arima_its_fixed_pq(as.Date("2020-05-19"), get(df),
              difference = 1,
              pulse = TRUE, step = TRUE,
              p = 0, q = 1)
  } else {
    arima_its_fixed_pq(as.Date("2020-05-19"), get(df),
              pulse = TRUE, step = TRUE,
              p = 0, q = 1)
  }
}

# October 2nd
for (df in dfs_posts) {
  print(df)
    arima_its_fixed_pq(as.Date("2020-10-02"), get(df),
              pulse = TRUE, ramp = TRUE, 
              p = 3, q = 0)
  }
```

## Interactions
- January 20th: p = 2, q = 0
- March 11th: p = 3, q = 1
- May 19th: p = 2, q = 0
- October 2nd: p = 3, q = 0
```{r}
# January 20th
dfs_posts <- c("obesity_interaction_per_day", "headaches_interaction_per_day", "clarinet_interaction_per_day")
for (df in dfs_posts) {
  print(df)
  arima_its_fixed_pq(as.Date("2020-01-20"), 
            get(df),
            difference = 1, 
            post_or_interaction = "interactions", 
            step = TRUE,
            p = 2, q = 0)
}

# March 11th
for (df in dfs_posts) {
  print(df)
  if (df != "clarinet_interaction_per_day") {
    arima_its_fixed_pq(as.Date("2020-03-11"), 
            get(df),
            difference = 1,
            post_or_interaction = "interactions", 
            pulse = TRUE,
            p = 3, q = 1)
  }
  else {
    arima_its_fixed_pq(as.Date("2020-03-11"),
                       get(df),
                       difference = 0,
                       post_or_interaction = "interactions",
                       pulse = TRUE,
                       p = 3, q = 1)
    
  }
}
# May 19th
for (df in dfs_posts) {
  print(df)
  if (df == "clarinet_interaction_per_day") {
    arima_its_fixed_pq(as.Date("2020-05-19"), 
              get(df),
              difference = 2, 
              post_or_interaction = "interactions",
              pulse = TRUE, step = TRUE, ramp = TRUE,
              p = 2, q = 0)
  } else {
    arima_its_fixed_pq(as.Date("2020-05-19"), 
              get(df),
              post_or_interaction = "interactions", 
              pulse = TRUE, step = TRUE, ramp = TRUE,
              p = 2, q = 0)
  }
}

# October 2nd
for (df in dfs_posts) {
  print(df)
  arima_its_fixed_pq(as.Date("2020-10-02"), 
            get(df),
            difference = 0, 
            post_or_interaction = "interactions", 
            pulse = TRUE,
            step = TRUE,
            p = 3, q = 0)
}
```

# Combining Into One Model
## Posts
January 20th: Ramp
March 11th: Pulse
May 19th: Pulse + Step
October 2nd: Pulse + Ramp
### Obesity Data
```{r}
all_count_per_day_restricted <- all_count_per_day %>%
  filter(post_created_date >= as.Date("2020-01-20") - 14 &
           post_created_date <= as.Date("2020-10-02") + 14) %>%
  mutate(pulse = case_when(
    post_created_date %in% c(as.Date("2020-03-11"), as.Date("2020-05-19"), as.Date("2020-10-02")) ~ 1,
    TRUE ~ 0),
    
    step = case_when(
      post_created_date >= as.Date("2020-05-19") &
        post_created_date <= as.Date("2020-05-19") + 14 ~ 1,
      TRUE ~ 0),
    
    ramp = case_when(
      post_created_date >= as.Date("2020-01-20") & 
        post_created_date <= as.Date("2020-01-20") + 14 ~ as.numeric(difftime(as.Date(post_created_date), as.Date("2020-01-20"), units = "days")),
      post_created_date >= as.Date("2020-10-02") &
        post_created_date <= as.Date("2020-10-02") + 14 ~ as.numeric(difftime(as.Date(post_created_date), as.Date("2020-10-02"), units = "days")),
      TRUE ~ 0),
    
    relevant_date_range = case_when(
      (post_created_date >= as.Date("2020-01-20") - 14 &
         post_created_date <= as.Date("2020-01-20") + 14) |
        (post_created_date >= as.Date("2020-03-11") - 14 & 
           post_created_date <= as.Date("2020-03-11") + 14) |
        (post_created_date >= as.Date("2020-05-19") - 14 &
           post_created_date <= as.Date("2020-05-19") + 14) |
        (post_created_date >= as.Date("2020-10-02") - 14 &
           post_created_date <= as.Date("2020-10-02") + 14) ~ 1,
      TRUE ~ 0),
    
    interruption = case_when(
      (post_created_date >= as.Date("2020-01-20") &
         post_created_date <= as.Date("2020-01-20") + 14) |
        (post_created_date >= as.Date("2020-03-11") & 
           post_created_date <= as.Date("2020-03-11") + 14) |
        (post_created_date >= as.Date("2020-05-19") &
           post_created_date <= as.Date("2020-05-19") + 14) |
        (post_created_date >= as.Date("2020-10-02") &
           post_created_date <= as.Date("2020-10-02") + 14) ~ 1,
      TRUE ~ 0),
    
    is_obesity = case_when(
      data_set == "Obesity" ~ 1,
      TRUE ~ 0),
    is_health_control = case_when(
      data_set == "Health Comparator" ~ 1,
      TRUE ~ 0),
    is_non_health_control = case_when(
      data_set == "Non-Health Comparator" ~ 1,
      TRUE ~ 0))

obesity_count_per_day_restricted <- all_count_per_day_restricted %>%
  filter(is_obesity == 1)

obesity_dat_ts <- ts(as.numeric(obesity_count_per_day_restricted$posts_per_day), start = min(obesity_count_per_day_restricted$post_created_date),
                     frequency = 365)

obesity_count_per_day_restricted_transfer <- obesity_count_per_day_restricted %>%
  mutate(jan_20_range = case_when(post_created_date >= as.Date("2020-01-20") - 14 & post_created_date <= as.Date("2020-01-20") + 14 ~ 1,
                                  TRUE ~ 0),
         mar_11_range = case_when(post_created_date >= as.Date("2020-03-11") - 14 & post_created_date <= as.Date("2020-03-11") + 14 ~ 1,
                                  TRUE ~ 0),
         may_19_range = case_when(post_created_date >= as.Date("2020-05-19") - 14 & post_created_date <= as.Date("2020-05-19") + 14 ~ 1,
                                  TRUE ~ 0),
         oct_02_range = case_when(post_created_date >= as.Date("2020-10-02") - 14 & post_created_date <= as.Date("2020-10-02") + 14 ~ 1,
                                  TRUE ~ 0),
         jan20_obesity_ramp = jan_20_range*is_obesity*ramp,
         mar11_obesity_pulse = mar_11_range*is_obesity*pulse,
         may19_obesity_pulse = may_19_range*is_obesity*pulse,
         may19_obesity_step = may_19_range*is_obesity*step,
         oct02_obesity_pulse = oct_02_range*is_obesity*pulse,
         oct02_obesity_ramp = oct_02_range*is_obesity*ramp) %>%
  select(jan20_obesity_ramp, mar11_obesity_pulse, may19_obesity_pulse, may19_obesity_step, oct02_obesity_pulse, oct02_obesity_ramp)

obesity_full_model <- auto.arima(obesity_dat_ts,
                         xreg = as.matrix(obesity_count_per_day_restricted_transfer),
                         stepwise = FALSE,
                         trace = TRUE,
                         max.order = 10)
summary(obesity_full_model)
print(confint(obesity_full_model))
print((1-pnorm(abs(obesity_full_model$coef)/sqrt(diag(obesity_full_model$var.coef))))*2)
```

### Health Control
```{r}
health_count_per_day_restricted <- all_count_per_day_restricted %>%
  filter(is_health_control == 1)

health_dat_ts <- ts(as.numeric(health_count_per_day_restricted$posts_per_day), start = min(health_count_per_day_restricted$post_created_date),
                     frequency = 365)

health_count_per_day_restricted_transfer <- health_count_per_day_restricted %>%
  mutate(jan_20_range = case_when(post_created_date >= as.Date("2020-01-20") - 14 & post_created_date <= as.Date("2020-01-20") + 14 ~ 1,
                                  TRUE ~ 0),
         mar_11_range = case_when(post_created_date >= as.Date("2020-03-11") - 14 & post_created_date <= as.Date("2020-03-11") + 14 ~ 1,
                                  TRUE ~ 0),
         may_19_range = case_when(post_created_date >= as.Date("2020-05-19") - 14 & post_created_date <= as.Date("2020-05-19") + 14 ~ 1,
                                  TRUE ~ 0),
         oct_02_range = case_when(post_created_date >= as.Date("2020-10-02") - 14 & post_created_date <= as.Date("2020-10-02") + 14 ~ 1,
                                  TRUE ~ 0),
         jan20_ramp = jan_20_range*ramp,
         mar11_pulse = mar_11_range*pulse,
         may19_pulse = may_19_range*pulse,
         may19_step = may_19_range*step,
         oct02_pulse = oct_02_range*pulse,
         oct02_ramp = oct_02_range*ramp) %>%
  select(jan20_ramp, mar11_pulse, may19_pulse, may19_step, oct02_pulse, oct02_ramp)

health_full_model <- auto.arima(health_dat_ts,
                         xreg = as.matrix(health_count_per_day_restricted_transfer),
                         stepwise = FALSE,
                         trace = TRUE,
                         max.order = 10)
summary(health_full_model)
print(confint(health_full_model))
print((1-pnorm(abs(health_full_model$coef)/sqrt(diag(health_full_model$var.coef))))*2)
```

### Non-Health Control
```{r}
nonhealth_count_per_day_restricted <- all_count_per_day_restricted %>%
  filter(is_non_health_control == 1)

nonhealth_dat_ts <- ts(as.numeric(nonhealth_count_per_day_restricted$posts_per_day), start = min(nonhealth_count_per_day_restricted$post_created_date),
                     frequency = 365)

nonhealth_count_per_day_restricted_transfer <- nonhealth_count_per_day_restricted %>%
  mutate(jan_20_range = case_when(post_created_date >= as.Date("2020-01-20") - 14 & post_created_date <= as.Date("2020-01-20") + 14 ~ 1,
                                  TRUE ~ 0),
         mar_11_range = case_when(post_created_date >= as.Date("2020-03-11") - 14 & post_created_date <= as.Date("2020-03-11") + 14 ~ 1,
                                  TRUE ~ 0),
         may_19_range = case_when(post_created_date >= as.Date("2020-05-19") - 14 & post_created_date <= as.Date("2020-05-19") + 14 ~ 1,
                                  TRUE ~ 0),
         oct_02_range = case_when(post_created_date >= as.Date("2020-10-02") - 14 & post_created_date <= as.Date("2020-10-02") + 14 ~ 1,
                                  TRUE ~ 0),
         jan20_nonhealth_ramp = jan_20_range*ramp,
         mar11_nonhealth_pulse = mar_11_range*pulse,
         may19_nonhealth_pulse = may_19_range*pulse,
         may19_nonhealth_step = may_19_range*step,
         oct02_nonhealth_pulse = oct_02_range*pulse,
         oct02_nonhealth_ramp = oct_02_range*ramp) %>%
  select(jan20_nonhealth_ramp, mar11_nonhealth_pulse, may19_nonhealth_pulse, may19_nonhealth_step, oct02_nonhealth_pulse, oct02_nonhealth_ramp)

nonhealth_full_model <- auto.arima(nonhealth_dat_ts,
                         xreg = as.matrix(nonhealth_count_per_day_restricted_transfer),
                         stepwise = FALSE,
                         trace = TRUE,
                         max.order = 10)
summary(nonhealth_full_model)
print(confint(nonhealth_full_model))
print((1-pnorm(abs(nonhealth_full_model$coef)/sqrt(diag(nonhealth_full_model$var.coef))))*2)
```

## Interactions
January 20th: Step
March 11th: Pulse
May 19th: Pulse + Step + Ramp
October 2nd: Pulse + Step
### Obesity Data
```{r}
all_int_per_day_restricted <- all_interactions_per_day %>%
  filter(post_created_date >= as.Date("2020-01-20") - 14 &
           post_created_date <= as.Date("2020-10-02") + 14) %>%
  mutate(pulse = case_when(
    post_created_date %in% c(as.Date("2020-03-11"), as.Date("2020-05-19"), as.Date("2020-10-02")) ~ 1,
    TRUE ~ 0),
    
    step = case_when(
      (post_created_date >= as.Date("2020-05-19") &
        post_created_date <= as.Date("2020-05-19") + 14) |
        (post_created_date >= as.Date("2020-01-20") &
           post_created_date <= as.Date("2020-01-20") + 14) |
        (post_created_date >= as.Date("2020-10-02") &
           post_created_date <= as.Date("2020-10-02") + 14) ~ 1,
      TRUE ~ 0),
    
    ramp = case_when(
      post_created_date >= as.Date("2020-05-19") &
        post_created_date <= as.Date("2020-05-19") + 14 ~ as.numeric(difftime(as.Date(post_created_date), as.Date("2020-05-19"), units = "days")),
      TRUE ~ 0),
    
    is_obesity = case_when(
      data_set == "Obesity" ~ 1,
      TRUE ~ 0),
    is_health_control = case_when(
      data_set == "Health Comparator" ~ 1,
      TRUE ~ 0),
    is_non_health_control = case_when(
      data_set == "Non-Health Comparator" ~ 1,
      TRUE ~ 0))

obesity_int_per_day_restricted <- all_int_per_day_restricted %>%
  filter(is_obesity == 1)

obesity_dat_ts <- ts(as.numeric(obesity_int_per_day_restricted$interactions_per_day), start = min(obesity_int_per_day_restricted$post_created_date),
                     frequency = 365)

obesity_in_per_day_restricted_transfer <- obesity_int_per_day_restricted %>%
  mutate(jan_20_range = case_when(post_created_date >= as.Date("2020-01-20") - 14 & post_created_date <= as.Date("2020-01-20") + 14 ~ 1,
                                  TRUE ~ 0),
         mar_11_range = case_when(post_created_date >= as.Date("2020-03-11") - 14 & post_created_date <= as.Date("2020-03-11") + 14 ~ 1,
                                  TRUE ~ 0),
         may_19_range = case_when(post_created_date >= as.Date("2020-05-19") - 14 & post_created_date <= as.Date("2020-05-19") + 14 ~ 1,
                                  TRUE ~ 0),
         oct_02_range = case_when(post_created_date >= as.Date("2020-10-02") - 14 & post_created_date <= as.Date("2020-10-02") + 14 ~ 1,
                                  TRUE ~ 0),
         jan20_obesity_step = jan_20_range*step,
         mar11_obesity_pulse = mar_11_range*pulse,
         may19_obesity_pulse = may_19_range*pulse,
         may19_obesity_step = may_19_range*step,
         may19_obesity_ramp = may_19_range*ramp,
         oct02_obesity_pulse = oct_02_range*pulse,
         oct02_obesity_step = oct_02_range*step) %>%
  select(jan20_obesity_step, mar11_obesity_pulse, may19_obesity_pulse, may19_obesity_step, may19_obesity_ramp, oct02_obesity_pulse, oct02_obesity_step)

obesity_full_model <- auto.arima(obesity_dat_ts,
                         xreg = as.matrix(obesity_in_per_day_restricted_transfer),
                         stepwise = FALSE,
                         trace = TRUE,
                         max.order = 10)
summary(obesity_full_model)
print(confint(obesity_full_model))
print((1-pnorm(abs(obesity_full_model$coef)/sqrt(diag(obesity_full_model$var.coef))))*2)
```

### Health Control
```{r}
health_int_per_day_restricted <- all_int_per_day_restricted %>%
  filter(is_health_control == 1)

health_dat_ts <- ts(as.numeric(health_int_per_day_restricted$interactions_per_day), start = min(health_int_per_day_restricted$post_created_date),
                     frequency = 365)

health_int_per_day_restricted_transfer <- health_int_per_day_restricted %>%
  mutate(jan_20_range = case_when(post_created_date >= as.Date("2020-01-20") - 14 & post_created_date <= as.Date("2020-01-20") + 14 ~ 1,
                                  TRUE ~ 0),
         mar_11_range = case_when(post_created_date >= as.Date("2020-03-11") - 14 & post_created_date <= as.Date("2020-03-11") + 14 ~ 1,
                                  TRUE ~ 0),
         may_19_range = case_when(post_created_date >= as.Date("2020-05-19") - 14 & post_created_date <= as.Date("2020-05-19") + 14 ~ 1,
                                  TRUE ~ 0),
         oct_02_range = case_when(post_created_date >= as.Date("2020-10-02") - 14 & post_created_date <= as.Date("2020-10-02") + 14 ~ 1,
                                  TRUE ~ 0),
         jan20_step = jan_20_range*step,
         mar11_pulse = mar_11_range*pulse,
         may19_pulse = may_19_range*pulse,
         may19_step = may_19_range*step,
         may19_ramp = may_19_range*ramp,
         oct02_pulse = oct_02_range*pulse,
         oct02_step = oct_02_range*step) %>%
  select(jan20_step, mar11_pulse, may19_pulse, may19_step, may19_ramp, oct02_pulse, oct02_step)

health_full_model <- auto.arima(health_dat_ts,
                         xreg = as.matrix(health_int_per_day_restricted_transfer),
                         stepwise = FALSE,
                         trace = TRUE,
                         max.order = 10)
summary(health_full_model)
print(confint(health_full_model))
print((1-pnorm(abs(health_full_model$coef)/sqrt(diag(health_full_model$var.coef))))*2)
```

### Non-Health Control
```{r}
nonhealth_int_per_day_restricted <- all_int_per_day_restricted %>%
  filter(is_non_health_control == 1)

nonhealth_dat_ts <- ts(as.numeric(nonhealth_int_per_day_restricted$interactions_per_day), start = min(nonhealth_int_per_day_restricted$post_created_date),
                     frequency = 365)

nonhealth_int_per_day_restricted_transfer <- nonhealth_int_per_day_restricted %>%
  mutate(jan_20_range = case_when(post_created_date >= as.Date("2020-01-20") - 14 & post_created_date <= as.Date("2020-01-20") + 14 ~ 1,
                                  TRUE ~ 0),
         mar_11_range = case_when(post_created_date >= as.Date("2020-03-11") - 14 & post_created_date <= as.Date("2020-03-11") + 14 ~ 1,
                                  TRUE ~ 0),
         may_19_range = case_when(post_created_date >= as.Date("2020-05-19") - 14 & post_created_date <= as.Date("2020-05-19") + 14 ~ 1,
                                  TRUE ~ 0),
         oct_02_range = case_when(post_created_date >= as.Date("2020-10-02") - 14 & post_created_date <= as.Date("2020-10-02") + 14 ~ 1,
                                  TRUE ~ 0),
         jan20_step = jan_20_range*step,
         mar11_pulse = mar_11_range*pulse,
         may19_pulse = may_19_range*pulse,
         may19_step = may_19_range*step,
         may19_ramp = may_19_range*ramp,
         oct02_pulse = oct_02_range*pulse,
         oct02_step = oct_02_range*step) %>%
  select(jan20_step, mar11_pulse, may19_pulse, may19_step, may19_ramp, oct02_pulse, oct02_step)

nonhealth_full_model <- auto.arima(nonhealth_dat_ts,
                         xreg = as.matrix(nonhealth_int_per_day_restricted_transfer),
                         stepwise = FALSE,
                         trace = TRUE,
                         max.order = 10)
summary(nonhealth_full_model)
print(confint(nonhealth_full_model))
print((1-pnorm(abs(nonhealth_full_model$coef)/sqrt(diag(nonhealth_full_model$var.coef))))*2)
```


