---
title: "facebook clustering"
author: "CCP"
date: "1/8/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Libraries
```{r}
library(tidyverse)
library(data.table)
library(magrittr)
library(janitor)
library(scales)
library(zoo)
library(tseries)
library(forecast)
library(tidytext)
```

# Data
```{r}
setwd("~/Documents/dartmouth/research/aim3_facebook_covid19_obesity/data")
bigrams <- fread("data220127_facebook_post_bigrams.csv")

obesity_topics <- fread("data220125_lda_topic_probabilities.csv") %>%
  clean_names()

obesity_meta <- fread("220120_feature_matrix_no_bert.csv") %>%
  clean_names()

headache_control <- fread("")
```

# Function
## ADF Test
```{r}
arima_its_adf_test <- function(its_date, 
                      dat, 
                      post_or_interaction = "post",
                      summary = FALSE) {
  first_date = as.Date(its_date) - 14
  last_date = as.Date(its_date) + 14
  
  dat_filtered <- dat %>%
      dplyr::filter(post_created_date >= first_date &
                    post_created_date <= last_date)
  
  date_seq <- seq.Date(from = as.Date(first_date),
                         length.out = nrow(dat_filtered),
                         by = 1)

  if (post_or_interaction == "post") {
      dat_ts <- ts(as.numeric(dat_filtered$posts_per_day), 
                              start = first_date,
                              frequency = 365)

  } else {
      dat_ts <- ts(as.numeric(dat_filtered$interactions_per_day), 
                                   start = first_date,
                                   frequency = 365)
  }
  
  if (summary == FALSE) {
    print(adf.test(dat_ts)) #Stationary data if significant (we want stationary)
  } else {
    adf_summary <- adf.test(dat_ts)
    if (adf_summary$p.value > 0.05) {
      print(paste0("Difference (p = ", round(adf_summary$p.value, 3), ")"))
    } else {
      print(paste0("No Difference Needed (p = ", round(adf_summary$p.value, 3), ")"))
    }
  }
}
```

## ARIMA- ITS
```{r}
## Note: If adf.test is not significant, that means data needs to be differenced and this function re-run with difference = TRUE. This function does not difference the data. 
arima_its <- function(its_date, 
                      dat, 
                      difference = NA,
                      pulse = FALSE,
                      step = FALSE,
                      ramp = FALSE,
                      post_or_interaction = "post",
                      aic_only = FALSE) {
  print(difference)
  first_date = as.Date(its_date) - 14
  last_date = as.Date(its_date) + 14
  
  dat_filtered <- dat %>%
      dplyr::filter(post_created_date >= first_date &
                    post_created_date <= last_date)
  
  date_seq <- seq.Date(from = as.Date(first_date),
                         length.out = nrow(dat_filtered),
                         by = 1)

  if (post_or_interaction == "post") {
      dat_ts <- ts(as.numeric(dat_filtered$posts_per_day), 
                              start = first_date,
                              frequency = 365)

  } else {
      dat_ts <- ts(as.numeric(dat_filtered$interactions_per_day), 
                                   start = first_date,
                                   frequency = 365)
  }
  
  #print(adf.test(dat_ts)) #Stationary data if significant (we want stationary)

## Step Parameter
  transfer <- c()
  if (step == TRUE) {
    dat_step <- ifelse(date_seq >= its_date, 1, 0)
    transfer <- cbind(transfer, dat_step)
  }

## Ramp Parameter
  if (ramp == TRUE) {
    dat_step <- ifelse(date_seq >= its_date, 1, 0)
    dat_ramp <- append(rep(0,
                         length(which(dat_step == 0))),
                     seq(1,
                         length(which(dat_step == 1)),
                         1))
    transfer <- cbind(transfer, dat_ramp)
  }
## Pulse Parameter
  if (pulse == TRUE) {
    dat_pulse <- ifelse(date_seq == its_date, 1, 0)
    transfer <- cbind(transfer, dat_pulse)
  }

  if (!is.na(difference)) {
    print(paste0("Running with differencing of ", difference))
      model_func <- auto.arima(dat_ts,
                               d = difference, #Considers differencing data
                               xreg = transfer)
  } else {
    print("Running with no differencing")
      model_func <- auto.arima(dat_ts,
                               xreg = transfer)
  }

  #print(Box.test(model_func$residuals, 
  #         type = "Ljung-Box")) 

  if (aic_only == TRUE) {
    return(model_func$aic)
  }
  else {
    print(summary(model_func))
    print(confint(model_func))
    print((1-pnorm(abs(model_func$coef)/sqrt(diag(model_func$var.coef))))*2) 
  }
}
```

# Picking Label for LDA Based on Max Prob.
```{r}
set.seed(110295)
obesity_topics %<>%
  replace(is.na(.), 0)

obesity_topics %<>%
  mutate(lda_topic = colnames(obesity_topics)[3:ncol(obesity_topics)][max.col(obesity_topics[,3:ncol(obesity_topics)],
                                                       ties.method="random")])
```

# Combine Feature Matrix and Topic
```{r}
obesity_meta %<>%
  select(-v1)

obesity_topics %<>%
  select(-v1)

obesity_meta$index <- as.numeric(obesity_meta$index)

obesity <- inner_join(obesity_meta, obesity_topics, by = "index")
```

# Number of Posts per Topic
```{r}
obesity %<>%
  as.data.frame()

obesity %<>%
  mutate(lda_topic_renamed = gsub("x", "", lda_topic),
         lda_topic_numeric = as.numeric(lda_topic_renamed) + 1,
         lda_topic_renamed = paste0("Topic: ", lda_topic_numeric))

View(obesity %>%
  group_by(lda_topic_numeric) %>%
  summarise(count = n()))

obesity %>%
  group_by(lda_topic_renamed) %>%
  summarise(count = n()) %>%
  ggplot(aes(y = reorder(lda_topic_renamed, count),
             x = count)) +
  geom_bar(stat = "identity",
           color = "black",
           fill = "#4267B2") +
  theme_classic() +
  labs(x = "Count",
       y = "Topic Number",
       title = "Number of Posts per LDA Topic - Facebook")
setwd("~/Documents/dartmouth/research/aim3_facebook_covid19_obesity/figures")
ggsave("220126_topic_counts.tiff",
       width = 7.25,
       height = 4.51)
```

# Distribution of Interactions per Topic
```{r}
obesity %<>%
    mutate(total_interactions_numeric =
             as.numeric(str_remove_all(total_interactions, 
                                       " ")))

View(obesity %>%
       group_by(lda_topic_numeric) %>%
       summarise(median(total_interactions_numeric,
                     na.rm = TRUE),
              quantile(total_interactions_numeric,
                       0.25,
                       na.rm = TRUE),
              quantile(total_interactions_numeric,
                       0.75,
                       na.rm = TRUE)))
     
obesity %>%
  group_by(lda_topic_renamed) %>%
  filter(total_interactions_numeric > 0) %>%
  mutate(median_total_interaction = median(log10(total_interactions_numeric),
                                         na.rm = TRUE)) %>%
  ggplot(aes(x = log10(total_interactions_numeric),
             y = reorder(lda_topic_renamed, 
                         median_total_interaction))) +
  geom_boxplot(color = "black",
               fill = "#4267B2") +
  theme_classic() +
  labs(x = "Log (Base 10) Interactions",
       y = "Topic Number",
       title = "Distribution of Interactions per LDA Topic - Facebook")
setwd("~/Documents/dartmouth/research/aim3_facebook_covid19_obesity/figures")
ggsave("220126_interaction_distribution_facebook.tiff",
       width = 7.25,
       height = 4.51)
```

## By Interaction Type
```{r}
obesity %>%
  #mutate(lda_facet = gsub("Topic: ", "", lda_topic_renamed)) %>%
  group_by(lda_topic_renamed) %>%
  select(likes, comments, shares, love, wow, haha, sad, angry, care, lda_topic_renamed) %>%
  melt(id = "lda_topic_renamed") %>%
  mutate(value = as.numeric(gsub(" ", "", value)),
         log_value = log10(value)) %>%
  filter(value > 0) %>%
  ggplot(aes(x = reorder_within(lda_topic_renamed,
                                log_value,
                                variable,
                                median),
             y = log_value,
             fill = variable)) +
  geom_boxplot(color = "black",
               outlier.size = 0.05,
               position = position_dodge(width = 2)) +
  theme_classic() +
  facet_wrap(~variable,
             scales = "free_y") +
  scale_x_reordered() +
  scale_fill_manual(values = c("#A0CBE8",
                                "#F28E2B",
                                "#8CD17D",
                                "#F1CE63",
                                "#86BCB6",
                                "#FF9D9A",
                                "#BAB0AC",
                                "#FABFD2",
                                "#D4A6C8")) + 
  coord_flip() + 
  theme(axis.text.y = element_text(size = 6),
        legend.position = "none") +
  labs(y = "Log (Base 10) Count",
       x = "Topic",
       title = "Distribution of Interactions by Type and Topic - Facebook")
setwd("~/Documents/dartmouth/research/aim3_facebook_covid19_obesity/figures")
ggsave("220126_interaction_distribution_facebook_facet.tiff",
       width = 7.25,
       height = 4.51)

View(obesity %>%
  group_by(lda_topic_renamed) %>%
  select(likes, comments, shares, love, wow, haha, sad, angry, care, lda_topic_renamed) %>%
  melt(id = "lda_topic_renamed") %>%
  mutate(value = as.numeric(gsub(" ", "", value)),
         log_value = log10(value)) %>%
  group_by(lda_topic_renamed, variable) %>%
  summarise(median(value, na.rm = TRUE),
            quantile(value, 0.25, na.rm = TRUE),
            quantile(value, 0.75, na.rm = TRUE)))
```

# Plot of Count per Day
```{r}
obesity %>%
  mutate(date_date = as.Date(post_created_date)) %>%
  group_by(lda_topic_renamed, date_date) %>%
  summarise(count_per_day = n()) %>%
  mutate(lda_topic_renamed = factor(lda_topic_renamed,
                                    levels = c("Topic: 1", "Topic: 2", "Topic: 3", "Topic: 4", "Topic: 5", "Topic: 6", "Topic: 7", "Topic: 8", "Topic: 9", "Topic: 10", "Topic: 11", "Topic: 12", "Topic: 13", "Topic: 14"))) %>%
  filter(date_date >= as.Date("2020-01-06"),
         date_date <= as.Date("2020-10-08")) %>%
  ggplot(aes(x = date_date,
             y = count_per_day,
             color = lda_topic_renamed)) +
  geom_line(size = 0.25) +
  geom_vline(xintercept = c(as.Date("2020-01-20"),
                            as.Date("2020-03-11"),
                            as.Date("2020-05-19"),
                            as.Date("2020-10-02")),
             linetype = "dashed") + 
  facet_wrap(~lda_topic_renamed,
             scales = "free_y") + 
  scale_color_manual(values = c("#DC050C",
                                "#E8601C", 
                                "#F1932D", 
                                "#F6C141", 
                                "#F7F056", 
                                "#CAE0AB", 
                                "#90C987", 
                                "#4EB265", 
                                "#7BAFDE", 
                                "#5289C7", 
                                "#1965B0", 
                                "#882E72", 
                                "#AE76A3", 
                                "#D1BBD7")) + 
  theme_classic() +
  theme(legend.position = "none") + 
  labs(x = "Date",
       y = "Count",
       title = "Number of Posts per Topic Per Day - Facebook")
setwd("~/Documents/dartmouth/research/aim3_facebook_covid19_obesity/figures")
ggsave("220126_topics_per_day_facet.tiff",
       width = 7.25, 
       height = 4.51)
```

# Metadata Analysis
```{r}
obesity_date_restricted <- obesity %>%
    filter(!is.na(post_created_date),
           post_created_date >= as.Date("2020-01-06"),
           post_created_date <= as.Date("2020-10-08"))

View(obesity %>%
  group_by(lda_topic_numeric) %>%
  mutate(denominator = n()) %>%
  group_by(lda_topic_numeric, page_category) %>%
  summarise(count = n(),
            percent = round(count/denominator*100, 2)) %>%
  arrange(lda_topic_numeric, desc(count)) %>%
  distinct(.) %>%
  ungroup() %>%
  group_by(lda_topic_numeric) %>%
  filter(row_number() <= 5))

View(obesity %>%
       group_by(page_category, page_name) %>%
       summarise(count = n()) %>%
       arrange(desc(count)) %>%
       ungroup() %>%
       group_by(page_category) %>%
       filter(row_number() == 1))
```

# Evaluating Number of LDA Clusters Over Time
## Running ARIMA
### Checking if Stationary
```{r}
list_of_its_dates <- c(as.Date("2020-01-20"),
                       as.Date("2020-03-11"),
                       as.Date("2020-05-19"),
                       as.Date("2020-10-02"))

topics_per_day <- obesity_date_restricted %>%
  group_by(lda_topic_numeric, post_created_date) %>%
  summarise(posts_per_day = n()) %>%
  filter(!is.na(post_created_date))

for (i in min(topics_per_day$lda_topic_numeric):max(topics_per_day$lda_topic_numeric)) {
  assign(paste0("topics_per_day_", i), topics_per_day %>%
           filter(lda_topic_numeric == i))
}

dfs <- c("topics_per_day_1", "topics_per_day_2", "topics_per_day_3", "topics_per_day_4", "topics_per_day_5", "topics_per_day_6", "topics_per_day_7", "topics_per_day_8", "topics_per_day_9", "topics_per_day_10", "topics_per_day_11", "topics_per_day_12", "topics_per_day_13", "topics_per_day_14")

for (d in list_of_its_dates) {
  print(as.Date(d))
  for (df in dfs) {
    print(df)
    arima_its_adf_test(d, get(df), summary = TRUE)
  }
}
```

### Checking Which Transfer Functions to Use
```{r}
aic_table <- NULL
for (df in dfs) {
  for (d in list_of_its_dates) {
    print(as.Date(d))
    print(df)
    aic_pulse = arima_its(d, get(df), pulse = TRUE, aic_only = TRUE)

    aic_step = arima_its(d, get(df), step = TRUE, aic_only = TRUE)

    aic_ramp = arima_its(d, get(df), ramp = TRUE, aic_only = TRUE)

    aic_pulse_step = arima_its(d, get(df), 
              pulse = TRUE, 
              step = TRUE, aic_only = TRUE)

    aic_pulse_ramp =  arima_its(d, get(df), 
                                pulse = TRUE, ramp = TRUE, aic_only = TRUE)

    aic_step_ramp = arima_its(d, get(df), 
                              step = TRUE, ramp = TRUE, aic_only = TRUE)

    aic_all = arima_its(d, get(df),
              pulse = TRUE, step = TRUE, ramp = TRUE, aic_only = TRUE)
    aic_table <- rbind(aic_table, 
                       cbind(df, d, 
                             aic_pulse, aic_step, aic_ramp, aic_pulse_step, aic_pulse_ramp, 
                             aic_step_ramp, aic_all))
  }
}

aic_table %<>%
  as.data.frame()

aic_table$best_transfer_function <- apply(aic_table, 1, FUN = function(x) names(x)[which.min(x)])

aic_table %<>%
  mutate_at(c("aic_pulse", "aic_step", "aic_ramp", "aic_pulse_step", "aic_pulse_ramp", "aic_step_ramp", "aic_all"),
            as.numeric) %>%
  rowwise() %>%
  mutate(best_aic = round(min(aic_pulse, aic_step, aic_ramp, aic_pulse_step, aic_pulse_ramp, aic_step_ramp, aic_all), 3)) %>%
  as.data.frame()

View(aic_table %>% select(df, d, best_aic, best_transfer_function))
```

### Running Models
```{r}
# January 20th
for (df in dfs) {
  print(df)
  p = FALSE
  r = FALSE
  s = FALSE
  if (df %in% c("topics_per_day_1", "topics_per_day_3", "topics_per_day_10", "topics_per_day_11", "topics_per_day_12", "topics_per_day_13", "topics_per_day_14")) {
    p = TRUE
  }
  else if (df %in% c("topics_per_day_4", "topics_per_day_6", "topics_per_day_9")) {
    s = TRUE
  } else {
    r = TRUE
  }
  arima_its(as.Date("2020-01-20"),
            get(df),
            pulse = p,
            step = s,
            ramp = r)
}

# March 11th
for (df in dfs) {
  print(df)
  p = FALSE
  r = FALSE
  s = FALSE
  if (df %in% c("topics_per_day_7", "topics_per_day_11", "topics_per_day_12")) {
    p = TRUE
  }
  if (df %in% c("topics_per_day_1", "topics_per_day_2", "topics_per_day_4", "topics_per_day_8", "topics_per_day_12")) {
    s = TRUE
  }
  if (df %in% c("topics_per_day_3", "topics_per_day_5", "topics_per_day_6", "topics_per_day_9", "topics_per_day_10", "topics_per_day_12", "topics_per_day_13", "topics_per_day_14")) {
    r = TRUE
  }
  arima_its(as.Date("2020-03-11"),
            get(df),
            pulse = p,
            step = s,
            ramp = r)
}

# May 19th
for (df in dfs) {
  print(df)
  p = FALSE
  r = FALSE
  s = FALSE
  if (df %in% c("topics_per_day_2", "topics_per_day_3", "topics_per_day_4", "topics_per_day_5", "topics_per_day_6", "topics_per_day_7", "topics_per_day_8", "topics_per_day_9", "topics_per_day_10", "topics_per_day_12", "topics_per_day_13")) {
    p = TRUE
  }
  if (df %in% c("topics_per_day_1", "topics_per_day_2", "topics_per_day_10", "topics_per_day_11", "topics_per_day_12", "topics_per_day_14")) {
    s = TRUE
  }
  if (df %in% c("topics_per_day_1", "topics_per_day_2", "topics_per_day_4", "topics_per_day_11")) {
    r = TRUE
  }
  arima_its(as.Date("2020-05-19"),
            get(df),
            pulse = p,
            step = s,
            ramp = r)
}

# October 2nd
for (df in dfs) {
  print(df)
  p = FALSE
  r = FALSE
  s = FALSE
  if (df %in% c("topics_per_day_1", "topics_per_day_2", "topics_per_day_3", "topics_per_day_4", "topics_per_day_7", "topics_per_day_8", "topics_per_day_9", "topics_per_day_12", "topics_per_day_14")) {
    p = TRUE
  }
  if (df %in% c("topics_per_day_1", "topics_per_day_2", "topics_per_day_5", "topics_per_day_6", "topics_per_day_7", "topics_per_day_11", "topics_per_day_13")) {
    s = TRUE
  }
  if (df %in% c("topics_per_day_2", "topics_per_day_6", "topics_per_day_7", "topics_per_day_10")) {
    r = TRUE
  }
  arima_its(as.Date("2020-10-02"),
            get(df),
            pulse = p,
            step = s,
            ramp = r)
}

```

# Bigram Analysis
```{r}
obesity_with_bigrams <- cbind(obesity, bigrams[2:nrow(bigrams)])
```

# LIWC Analysis
```{r}
liwc_vader <- colnames(obesity)[c(356:359, 403:495)]

for (var in liwc_vader) {
  aov(lda_topic)
}
```


